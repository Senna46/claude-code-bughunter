# Docker Compose for Claude Code BugHunter
# Persists state DB and cloned repos in a named volume.
#
# Authentication:
#   GitHub: Set GH_TOKEN in .env (required on macOS, optional on Linux)
#   Claude: Set CLAUDE_CODE_OAUTH_TOKEN in .env (required on macOS)
#           On Linux, file-based auth via volume mount works automatically.
#
# To get CLAUDE_CODE_OAUTH_TOKEN, run: claude setup-token

services:
  bughunter:
    build: .
    container_name: claude-code-bughunter
    restart: unless-stopped
    env_file: .env
    environment:
      - BUGHUNTER_WORK_DIR=/data/repos
      - BUGHUNTER_DB_PATH=/data/db/state.db
    volumes:
      # Persist state and cloned repos
      - bughunter-data:/data

      # Mount gh CLI auth (read-only)
      # On Linux: hosts.yml contains the token, file mount is sufficient
      # On macOS: hosts.yml exists but keyring holds the token, GH_TOKEN env var is required
      - ${HOME}/.config/gh:/root/.config/gh:ro

      # Mount claude CLI data (read-write: claude CLI writes debug/stats during operation)
      # On Linux: this also contains .credentials.json (sufficient for auth)
      # On macOS: credentials are in Keychain, not in files.
      #           Set CLAUDE_CODE_OAUTH_TOKEN env var instead.
      - ${HOME}/.claude:/root/.claude

      # Mount claude.json (onboarding state, read-write)
      # Note: If the file doesn't exist on host, Docker creates a directory.
      # The entrypoint script detects and fixes this automatically.
      - ${HOME}/.claude.json:/root/.claude.json

volumes:
  bughunter-data:
